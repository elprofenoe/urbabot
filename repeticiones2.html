<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urbabot - Repeticiones y Clasificación</title>
    <style>
        :root {
            --primary: #2e7d32;
            --secondary: #fbc02d;
            --bg: #f1f8e9;
            --cell-size: 60px;
        }
        body { font-family: 'Arial', sans-serif; background-color: var(--bg); display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        .header { text-align: center; color: var(--primary); }
        .game-container { display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap; justify-content: center; }
        
        /* Tablero */
        #grid { 
            display: grid; 
            grid-template-columns: repeat(7, var(--cell-size)); 
            grid-template-rows: repeat(7, var(--cell-size)); 
            gap: 2px; background: #555; border: 5px solid #333; 
        }
        .cell { width: var(--cell-size); height: var(--cell-size); background: white; display: flex; align-items: center; justify-content: center; position: relative; }
        
        /* Paneles y Bloques */
        .panel { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 220px; }
        .toolbox .command { 
            background: #4caf50; color: white; padding: 12px; margin: 8px 0; 
            cursor: grab; border-radius: 6px; text-align: center; font-weight: bold; font-size: 14px;
        }
        .command.action { background: #ff9800; } 
        .command.repeat { background: #2196f3; }
        .executing { border: 3px solid #fbc02d; box-shadow: 0 0 15px #fbc02d; transform: scale(1.05); }

        .workspace { min-height: 350px; border: 3px dashed #bbb; margin-top: 10px; padding: 10px; border-radius: 8px; }
        
        /* Urbabot y Objetos SVG integrados */
        .urbabot { width: 80%; transition: all 0.3s; z-index: 10; }
        .item { width: 50%; z-index: 5; }
        .target { width: 75%; height: 75%; border: 4px dashed; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 10px; opacity: 0.7; }

        .controls { margin-top: 20px; display: flex; gap: 10px; }
        button { padding: 12px 25px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; transition: 0.2s; }
        button:hover { opacity: 0.9; transform: scale(1.05); }
        .run-btn { background: #2e7d32; }
        .reset-btn { background: #d32f2f; }
    </style>
</head>
<body>

<div class="header">
    <h1>Urbabot: Repeticiones y Colores</h1>
    <p>Nivel: <strong id="lvl-num">1</strong> de 10</p>
    <p id="msg" style="background: #fff; padding: 5px 15px; border-radius: 20px; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);">
        Instrucción: ¡Lleva el bote a su contenedor usando REPETIR!
    </p>
</div>

<audio id="snd-move" src="sounds/move.mp3"></audio>
<audio id="snd-pick" src="sounds/pickup.mp3"></audio>
<audio id="snd-win" src="sounds/win.mp3"></audio>
<audio id="snd-error" src="sounds/error.mp3"></audio>

<div class="game-container">
    <div class="panel toolbox">
        <h3>Comandos</h3>
        <div class="command" draggable="true" ondragstart="drag(event)" id="move">MOVER</div>
        <div class="command" draggable="true" ondragstart="drag(event)" id="turn">GIRAR ↻</div>
        <div class="command action" draggable="true" ondragstart="drag(event)" id="pickup">RECOGER</div>
        <div class="command action" draggable="true" ondragstart="drag(event)" id="dropoff">DEPOSITAR</div>
        <div class="command repeat" draggable="true" ondragstart="drag(event)" id="repeat3">REPETIR (3x)</div>
    </div>

    <div id="grid"></div>

    <div class="panel">
        <h3>Tu Código</h3>
        <div class="workspace" id="workspace" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
    </div>
</div>

<div class="controls">
    <button class="run-btn" onclick="ejecutarCodigo()">¡EMPEZAR!</button>
    <button class="reset-btn" onclick="reiniciarNivel()">REINTENTAR</button>
</div>

<script>
    // Configuración detallada de los 10 niveles
    const niveles = [
        { id: 1, start: {x:0, y:3, dir:0}, item: {x:3, y:3, color: 'green'}, target: {x:6, y:3, color: 'green'}, msg: "Mueve 3 veces, recoge y mueve 3 más." },
        { id: 2, start: {x:3, y:0, dir:1}, item: {x:3, y:3, color: 'black'}, target: {x:3, y:6, color: 'black'}, msg: "Repite hacia abajo para recoger el bote negro." },
        { id: 3, start: {x:0, y:6, dir:0}, item: {x:3, y:6, color: '#ddd'}, target: {x:6, y:6, color: '#ddd'}, msg: "¡Bote blanco! Usa repetir para llegar a la meta." },
        { id: 4, start: {x:1, y:1, dir:1}, item: {x:1, y:4, color: 'green'}, target: {x:4, y:4, color: 'green'}, msg: "Gira después de recoger el bote verde." },
        { id: 5, start: {x:6, y:1, dir:2}, item: {x:3, y:1, color: 'black'}, target: {x:3, y:4, color: 'black'}, msg: "Calcula bien los pasos y los giros." },
        { id: 6, start: {x:0, y:0, dir:0}, item: {x:3, y:0, color: '#ddd'}, target: {x:3, y:3, color: '#ddd'}, msg: "Usa repetir para moverte por los pasillos." },
        { id: 7, start: {x:5, y:5, dir:3}, item: {x:5, y:2, color: 'green'}, target: {x:2, y:2, color: 'green'}, msg: "¡Urbabot va hacia arriba! Repetir 3 veces." },
        { id: 8, start: {x:0, y:5, dir:0}, item: {x:3, y:5, color: 'black'}, target: {x:6, y:5, color: 'black'}, msg: "Línea larga: Dos bloques de repetir te ayudarán." },
        { id: 9, start: {x:3, y:6, dir:3}, item: {x:3, y:3, color: '#ddd'}, target: {x:0, y:3, color: '#ddd'}, msg: "Recoge el blanco y gira a la izquierda." },
        { id: 10, start: {x:0, y:0, dir:1}, item: {x:0, y:3, color: 'green'}, target: {x:0, y:6, color: 'green'}, msg: "Último reto: ¡Limpia toda la columna!" }
    ];

    let lvlIdx = 0;
    let bot = { ...niveles[0].start };
    let tieneItem = false;

    function dibujarEscenario() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        const nv = niveles[lvlIdx];
        document.getElementById('msg').innerText = nv.msg;
        
        for (let y = 0; y < 7; y++) {
            for (let x = 0; x < 7; x++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                if (x === bot.x && y === bot.y) {
                    cell.innerHTML = `<svg class="urbabot" style="transform: rotate(${bot.dir * 90}deg)" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="#2196F3"/><path d="M50 20 L70 50 L30 50 Z" fill="white"/></svg>`;
                } else if (x === nv.item.x && y === nv.item.y && !tieneItem) {
                    cell.innerHTML = `<svg class="item" viewBox="0 0 100 100"><rect x="25" y="20" width="50" height="70" fill="${nv.item.color}" stroke="#333" stroke-width="5"/><path d="M25 40 H75 M25 60 H75" stroke="#333"/></svg>`;
                } else if (x === nv.target.x && y === nv.target.y) {
                    cell.innerHTML = `<div class="target" style="border-color: ${nv.target.color}; color: ${nv.target.color}">DESTINO</div>`;
                }
                grid.appendChild(cell);
            }
        }
    }

    // Funciones de Sonido
    function playSnd(id) { 
        const s = document.getElementById(id); 
        if(s) { s.currentTime = 0; s.play().catch(()=>{}); } 
    }

    // Lógica Drag & Drop mejorada
    function drag(ev) { ev.dataTransfer.setData("text", ev.target.id); }
    function allowDrop(ev) { ev.preventDefault(); }
    function drop(ev) {
        ev.preventDefault();
        const data = ev.dataTransfer.getData("text");
        const original = document.getElementById(data);
        if(!original) return;
        const clone = original.cloneNode(true);
        clone.id = "c-" + Math.random();
        clone.onclick = function() { this.remove(); }; // Click para borrar
        ev.target.appendChild(clone);
    }

    async function ejecutarCodigo() {
        const programa = Array.from(document.getElementById('workspace').children);
        if (programa.length === 0) return;
        
        const nv = niveles[lvlIdx];

        for (let bloque of programa) {
            // Resaltar bloque en ejecución
            bloque.classList.add('executing');
            
            let tipo = bloque.id.split('-')[0];
            if (tipo === 'move') { await mover(1); playSnd('snd-move'); }
            if (tipo === 'turn') { bot.dir = (bot.dir + 1) % 4; playSnd('snd-move'); }
            if (tipo === 'pickup') {
                if (bot.x === nv.item.x && bot.y === nv.item.y) { tieneItem = true; playSnd('snd-pick'); }
                else { playSnd('snd-error'); alert("¡No hay nada aquí!"); break; }
            }
            if (tipo === 'dropoff') {
                if (tieneItem && bot.x === nv.target.x && bot.y === nv.target.y) {
                    playSnd('snd-win');
                    alert("¡Nivel Superado!");
                    siguienteNivel();
                    return;
                } else {
                    playSnd('snd-error');
                    alert("¡Lugar equivocado o no tienes el bote!");
                    break;
                }
            }
            if (tipo === 'repeat3') {
                for(let i=0; i<3; i++) { 
                    await mover(1); playSnd('snd-move');
                    dibujarEscenario(); await new Promise(r => setTimeout(r, 300)); 
                }
            }

            dibujarEscenario();
            await new Promise(r => setTimeout(r, 600));
            bloque.classList.remove('executing');
        }
    }

    function mover(p) {
        return new Promise(resolve => {
            if (bot.dir === 0) bot.x = Math.min(6, bot.x + p);
            if (bot.dir === 1) bot.y = Math.min(6, bot.y + p);
            if (bot.dir === 2) bot.x = Math.max(0, bot.x - p);
            if (bot.dir === 3) bot.y = Math.max(0, bot.y - p);
            resolve();
        });
    }

    function siguienteNivel() {
        lvlIdx++;
        if (lvlIdx >= niveles.length) { alert("¡Campeón de la limpieza!"); lvlIdx = 0; }
        document.getElementById('lvl-num').innerText = lvlIdx + 1;
        reiniciarNivel();
    }

    function reiniciarNivel() {
        bot = { ...niveles[lvlIdx].start };
        tieneItem = false;
        document.getElementById('workspace').innerHTML = '';
        dibujarEscenario();
    }

    dibujarEscenario();
</script>
</body>
</html>